import { spawn } from "child_process";import chokidar from "chokidar";import http from "http";import path from "path";import fs from "fs/promises";const DIST=path.resolve("dist"),PORT=3000;const runBuild=()=>new Promise((res,rej)=>{const p=spawn("node",["scripts/build.mjs"],{stdio:"inherit",env:{...process.env,NODE_ENV:"development"}});p.on("exit",c=>c===0?res():rej(new Error(`build failed: ${c}`)));});await runBuild();http.createServer(async(req,r)=>{try{const u=new URL(req.url,`http://localhost:${PORT}`);let p=u.pathname;if(p.endsWith("/")&&p!=="/")p=p.slice(0,-1);const clean=p.replace(/^\//,"");const isAsset=/\.(css|js|png|jpg|jpeg|webp|avif|svg|ico)$/i.test(p);const fp=p==="/"?path.join(DIST,"index.html"):(isAsset?path.join(DIST,clean):path.join(DIST,clean,"index.html"));const d=await fs.readFile(fp);r.writeHead(200,{"Content-Type":"text/html; charset=utf-8"});r.end(d);}catch{r.writeHead(404);r.end("404 Not Found");}}).listen(PORT,()=>console.log(`âœ… Dev server: http://localhost:${PORT}`));let b=false;chokidar.watch("src",{ignoreInitial:true}).on("all",async()=>{if(b)return;b=true;try{await runBuild();console.log("ğŸ” Rebuilt");}catch(e){console.error("âŒ Build failed:",e.message);}finally{b=false;}});